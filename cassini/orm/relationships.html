<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="HandheldFriendly" content="True"/>
<title>Mapper Relationships</title>
    
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/cerulean/bootstrap.min.css" />
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
<link rel="stylesheet" href="https://tobiju.github.io/share/prismjs/prism-base16-ateliersulphurpool.light.css" />
<link rel="stylesheet" href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css" />
<link rel="stylesheet" href="/style.css" />
</head>
<body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-cerulean">
<div class="page-wrapper">
    <header>
    
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="box-header container">
        <form class="form-search navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text"
                       placeholder="Search"
                       class="js-search-input form-control"
                       data-roothref="/">

                <div class="js-search-results"></div>
            </div>
        </form>

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
                            <a class="navbar-brand" href="/">
                    <img alt="logo" src="https://raw.githubusercontent.com/atlasphp/atlasphp.github.io/master/images/atlas.png" title="Home">
                </a>
                    </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
                        <li>
    <a href="/dymaxion/">Dymaxion (v4)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/dymaxion/pdo/">PDO Connection</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/dymaxion/pdo/connection.html">PDO Connection</a>

    </li>
                        <li>
    <a href="/dymaxion/pdo/connection-locator.html">Connection Locator</a>

    </li>
                        <li>
    <a href="/dymaxion/pdo/upgrade.html">Upgrade Notes</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/dymaxion/statement/">Query Statement Builders</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/dymaxion/statement/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/binding.html">Value Binding</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/ctes.html">Common Table Expressions</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/select.html">SELECT</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/insert.html">INSERT</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/update.html">UPDATE</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/delete.html">DELETE</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/other.html">Other Topics</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/dymaxion/query/">Query Statement Performers</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/dymaxion/query/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/dymaxion/query/execution.html">Query Execution</a>

    </li>
                        <li>
    <a href="/dymaxion/query/upgrade.html">Upgrade Notes</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/">Cassini (v3)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/orm/">ORM</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/orm/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/cassini/orm/relationships.html">Mapper Relationships</a>

    </li>
                        <li>
    <a href="/cassini/orm/reading.html">Fetching Records and RecordSets</a>

    </li>
                        <li>
    <a href="/cassini/orm/records.html">Working with Records</a>

    </li>
                        <li>
    <a href="/cassini/orm/record-sets.html">Working with RecordSets</a>

    </li>
                        <li>
    <a href="/cassini/orm/transactions.html">Transactions</a>

    </li>
                        <li>
    <a href="/cassini/orm/behavior.html">Record and RecordSet Behaviors</a>

    </li>
                        <li>
    <a href="/cassini/orm/events.html">Events</a>

    </li>
                        <li>
    <a href="/cassini/orm/direct.html">Direct Queries</a>

    </li>
                        <li>
    <a href="/cassini/orm/other.html">Other Topics</a>

    </li>
                        <li>
    <a href="/cassini/orm/domain.html">Domain Models</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/skeleton/">Skeleton Generator</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/skeleton/usage.html">Usage</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/table/">Table Data Gateway</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/table/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/cassini/table/reading.html">Reading From The Table</a>

    </li>
                        <li>
    <a href="/cassini/table/writing.html">Writing To The Table</a>

    </li>
                        <li>
    <a href="/cassini/table/events.html">Table Events</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/query/">Query System</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/query/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/cassini/query/binding.html">Value Binding</a>

    </li>
                        <li>
    <a href="/cassini/query/select.html">SELECT</a>

    </li>
                        <li>
    <a href="/cassini/query/insert.html">INSERT</a>

    </li>
                        <li>
    <a href="/cassini/query/update.html">UPDATE</a>

    </li>
                        <li>
    <a href="/cassini/query/delete.html">DELETE</a>

    </li>
                        <li>
    <a href="/cassini/query/other.html">Other Topics</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/info/">Schema Information</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/info/usage.html">Usage</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/pdo/">PDO Connection</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/pdo/connection.html">PDO Connection</a>

    </li>
                        <li>
    <a href="/cassini/pdo/connection-locator.html">Connection Locator</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/boggs/">Boggs (v2)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/boggs/mapper/">ORM</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/boggs/mapper/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/boggs/mapper/relationships.html">Mapper Relationships</a>

    </li>
                        <li>
    <a href="/boggs/mapper/reading.html">Fetching Records and RecordSets</a>

    </li>
                        <li>
    <a href="/boggs/mapper/records.html">Working with Records</a>

    </li>
                        <li>
    <a href="/boggs/mapper/record-sets.html">Working with RecordSets</a>

    </li>
                        <li>
    <a href="/boggs/mapper/transactions.html">Transactions (Unit of Work)</a>

    </li>
                        <li>
    <a href="/boggs/mapper/behavior.html">Record and RecordSet Behaviors</a>

    </li>
                        <li>
    <a href="/boggs/mapper/events.html">Events</a>

    </li>
                        <li>
    <a href="/boggs/mapper/direct.html">Direct Queries</a>

    </li>
                        <li>
    <a href="/boggs/mapper/domain.html">Domain Models</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/boggs/skeleton/">Skeleton Generator</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/boggs/skeleton/getting-started.html">Atlas.Cli 1.x</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/albers/">Albers (v1)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/albers/mapper/">ORM</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/albers/mapper/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/albers/mapper/relationships.html">Mapper Relationships</a>

    </li>
                        <li>
    <a href="/albers/mapper/reading.html">Fetching Records and RecordSets</a>

    </li>
                        <li>
    <a href="/albers/mapper/records.html">Working with Records</a>

    </li>
                        <li>
    <a href="/albers/mapper/record-sets.html">Working with RecordSets</a>

    </li>
                        <li>
    <a href="/albers/mapper/transactions.html">Transactions (Unit of Work)</a>

    </li>
                        <li>
    <a href="/albers/mapper/behavior.html">Record and RecordSet Behaviors</a>

    </li>
                        <li>
    <a href="/albers/mapper/events.html">Events</a>

    </li>
                        <li>
    <a href="/albers/mapper/direct.html">Direct Queries</a>

    </li>
                        <li>
    <a href="/albers/mapper/domain.html">Domain Models</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/albers/skeleton/">Skeleton Generator</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/albers/skeleton/getting-started.html">Atlas.Cli 1.x</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <ol class="breadcrumb">
                        <li><a href="/">Atlas Database Framework for PHP</a></li>
                                <li><a href="/cassini/">Cassini (v3)</a></li>
                                <li><a href="/cassini/orm/">ORM</a></li>
                                <li class="active">Mapper Relationships</li>
            </ol>
    <div class="row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#2-1-2" title="Mapper&#x20;Relationships">Mapper Relationships</a>
            </li>
                                <li>
                <a href="#2-1-2-1" title="Relationship&#x20;Key&#x20;Columns">Relationship Key Columns</a>
            </li>
                                <li>
                <a href="#2-1-2-2" title="Composite&#x20;Relationship&#x20;Keys">Composite Relationship K...</a>
            </li>
                                <li>
                <a href="#2-1-2-3" title="Case-Sensitivity">Case-Sensitivity</a>
            </li>
                                <li>
                <a href="#2-1-2-4" title="Simple&#x20;WHERE&#x20;Conditions">Simple WHERE Conditions</a>
            </li>
                                <li>
                <a href="#2-1-2-5" title="Variant&#x20;Relationships">Variant Relationships</a>
            </li>
                                <li>
                <a href="#2-1-2-6" title="Many-To-Many&#x20;Relationships">Many-To-Many Relationshi...</a>
            </li>
                                <li>
                <a href="#2-1-2-7" title="Cascading&#x20;Deletes">Cascading Deletes</a>
            </li>
            </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="2-1-2">2.1.2. Mapper Relationships</h1>
<p>You can add to the <em>MapperRelationships</em> inside the relevant <code>define()</code> method,
calling one of these relationship-definition methods:</p>
<ul>
<li>
<code>oneToOne($field, $mapperClass)</code> (aka "has one")</li>
<li>
<code>oneToOneBidi($field, $mapperClass)</code> for a bidirectional relationship</li>
<li>
<code>oneToMany($field, $mapperClass)</code> (aka "has many")</li>
<li>
<code>manyToOne($field, $mapperClass)</code> (aka "belongs to")</li>
<li>
<code>manyToOneVariant($field, $typeCol)</code> (aka "polymorphic association")</li>
<li>
<code>manyToMany($field, $mapperClass, $throughField)</code> (aka "has many through")</li>
</ul>
<p>The <code>$field</code> will become a field name on the returned Record object.</p>
<p>Here is an example:</p>
<pre><code class="language-php">namespace App\DataSource\Thread;

use App\DataSource\Author\Author;
use App\DataSource\Summary\Summary;
use App\DataSource\Reply\Reply;
use App\DataSource\Tagging\Tagging;
use App\DataSource\Tag\Tag;
use Atlas\Mapper\MapperRelationships;

class ThreadRelationships extends MapperRelationships
{
    protected function define()
    {
        $this-&gt;manyToOne('author', Author::CLASS);
        $this-&gt;oneToOne('summary', Summary::CLASS);
        $this-&gt;oneToMany('replies', Reply::CLASS);
        $this-&gt;oneToMany('taggings', Tagging::CLASS);
    }
}
</code></pre>
<h2 id="2-1-2-1">2.1.2.1. Relationship Key Columns</h2>
<p>By default, in all relationships except many-to-one, the relationship will take
the primary key column(s) in the native table, and map to those same column
names in the foreign table.</p>
<p>In the case of many-to-one, it is the reverse; that is, the relationship will
take the primary key column(s) in the foreign table, and map to those same
column names in the native table.</p>
<p>If you want to use different columns, pass an array of native-to-foreign column
names as the third parameter. For example, if the threads table uses
<code>author_id</code>, but the authors table uses just <code>id</code>, you can do this:</p>
<pre><code class="language-php">class ThreadRelationships extends MapperRelationships
{
    protected function define()
    {
        $this-&gt;manyToOne('author', Author::CLASS, [
            // native (threads) column =&gt; foreign (authors) column
            'author_id' =&gt; 'id',
        ]);
    }
}

</code></pre>
<p>And on the <code>oneToMany</code> side of the relationship, you use the native author table
<code>id</code> column with the foreign threads table <code>author_id</code> column.</p>
<pre><code class="language-php">class AuthorRelationships extends MapperRelationships
{
    protected function define()
    {
        $this-&gt;oneToMany('threads', Thread::CLASS, [
            // native (author) column =&gt; foreign (threads) column
            'id' =&gt; 'author_id',
        ]);
    }
}
</code></pre>
<h2 id="2-1-2-2">2.1.2.2. Composite Relationship Keys</h2>
<p>Likewise, if a table uses a composite key, you can re-map the relationship on
multiple columns. If table <code>foo</code> has composite primary key columns of <code>acol</code> and
<code>bcol</code>, and it maps to table <code>bar</code> on <code>foo_acol</code> and <code>foo_bcol</code>, you would do
this:</p>
<pre><code class="language-php">class FooRelationships extends MapperRelationships
{
    protected function define()
    {
        $this-&gt;oneToMany('bars', Bar::CLASS, [
            // native (foo) column =&gt; foreign (bar) column
            'acol' =&gt; 'foo_acol',
            'bcol' =&gt; 'foo_bcol',
        ]);
    }
}
</code></pre>
<h2 id="2-1-2-3">2.1.2.3. Case-Sensitivity</h2>
<blockquote>
<p><strong>Note:</strong>
This applies only to <strong>string-based</strong> relationship keys. If you are
using numeric relationship keys, this section does not apply.</p>
</blockquote>
<p>Atlas will match records related by string keys in a case-senstive manner. If
your collations on the related string key columns are <em>not</em> case sensitive,
Atlas might not match up related records properly in memory after fetching them
from the database. This is because 'foo' and 'FOO' might be equivalent in the
database collation, but they are <em>not</em> equivalent in PHP.</p>
<p>In that kind of situation, you will want to tell the relationship to ignore the
case of related string key columns when matching related records. You can do so
with the <code>ignoreCase()</code> method on the relationship definition.</p>
<pre><code class="language-php">class FooRelationships
{
    protected function define()
    {
        $this-&gt;oneToMany('bars', Bar::CLASS)
            -&gt;ignoreCase();
    }
}
</code></pre>
<p>With that in place, a native value of 'foo' match to a foreign value of 'FOO'
when Atlas is stitching together related records.</p>
<h2 id="2-1-2-4">2.1.2.4. Simple WHERE Conditions</h2>
<p>You may find it useful to define simple WHERE conditions on the foreign side of
the relationship. For example, you can handle one side of a many-to-one-variant
(aka "polymorphic association") by selecting only related records of a
particular type.</p>
<p>In the following example, a <code>comments</code> table has a <code>commentable_id</code> column as
the foreign key value, but is restricted to "video" values on a discriminator
column named <code>commentable_type</code>.</p>
<pre><code class="language-php">class Video extends Mapper
{
    protected function define()
    {
        $this-&gt;oneToMany('comments', Comment::CLASS, [
            'video_id' =&gt; 'commentable_id'
        ])-&gt;where('commentable_type = ', 'video');
    }
}
</code></pre>
<p>(These conditions will be honored by <code>MapperSelect::*joinWith()</code> as well.)</p>
<h2 id="2-1-2-5">2.1.2.5. Variant Relationships</h2>
<p>The many-to-one-variant relationship is somewhat different from the other
relationship types. It is identical to a many-to-one relationship, except that
the relationships vary by a type (or "discriminator") column in the native
table. This allows rows in the native table to "belong to" rows in more than one
foreign table. The typical example is one of comments that can be created on
many different types of content, such as static pages, blog posts, and video
links.</p>
<pre><code class="language-php">class CommentRelationships extends MapperRelationships
{
    protected function define()
    {
        // The first argument is the field name on the native record;
        // the second argument is the type column on the native table.
        $this-&gt;manyToOneVariant('commentable', 'commentable_type')

            // The first argument is the value of the commentable_type column;
            // the second is the related foreign mapper class;
            // the third is the native-to-foreign column mapping.
            -&gt;type('page', Page::CLASS, ['commentable_id' =&gt; 'page_id'])
            -&gt;type('post', Post::CLASS, ['commentable_id' =&gt; 'post_id'])
            -&gt;type('video', Video::CLASS, ['commentable_id' =&gt; 'video_id']);
    }
}
</code></pre>
<p>Note that there will be one query per variant type in the native record set.
That is, if a native record set (of an arbitrary number of records) refers to a
total of three different variant types, then Atlas will issue three additional
queries to fetch the related records.</p>
<h2 id="2-1-2-6">2.1.2.6. Many-To-Many Relationships</h2>
<p>The many-to-many relationship retrieves foreign records via an association
table (a.k.a. a "through" relationship). This is typically modeled as a
one-to-many from the native mapper to the related "through" mapper, where the
"through" mapper itself has a many-to-one relationship to the foreign mapper.</p>
<p>When setting up a many-to-many relationship, make sure the "through" mapper has
a many-to-one relationship to both sides of the relationship. For example,
given a <code>threads</code> table, related to <code>tags</code>, through a <code>taggings</code> table:</p>
<pre><code class="language-php">class ThreadRelationships extends MapperRelationships
{
    protected function define()
    {
        // the "through" relationship that joins threads and tags
        $this-&gt;oneToMany('taggings', Tagging::CLASS);

        // the "foreign" relationship "through" taggings
        $this-&gt;manyToMany('tags', Tag::CLASS, 'taggings');
    }
}

class TaggingRelationships extends MapperRelationships
{
    protected function define()
    {
        // the threads side of the association mapping
        $this-&gt;manyToOne('threads', Thread::CLASS);

        // the tags side of the association mapping
        $this-&gt;manyToOne('tags', Tag::CLASS);
    }
}

class TagRelationships extends MapperRelationships
{
    protected function define()
    {
        // the "through" relationship that joins threads and tags
        $this-&gt;oneToMany('taggings', Tagging::CLASS);

        // the "foreign" relationship "through" taggings
        $this-&gt;manyToMany('threads', Thread::CLASS, 'taggings');
    }
}
</code></pre>
<h2 id="2-1-2-7">2.1.2.7. Cascading Deletes</h2>
<p>Atlas relationships support various form of cascading deletion. That is, when
you <code>delete()</code> a Record, whether directly or via a <code>persist()</code>
call, Atlas can automatically modify its related (foreign child) Records
as desired, either in memory or at the database.</p>
<blockquote>
<p><strong>Note:</strong></p>
<p>Cascading deletes cannot operate on many-to-one relationships, since that kind
of foreign Record is on the parent/owner side. They only operate on one-to-one
and one-to-many foreign records (i.e., the child/owned side).</p>
<p>Note also that cascading deleted operate only on loaded relationships; they
cannot operate on Records not already in memory.</p>
</blockquote>
<p>Call one of the following methods on the relationship definition to set up
cascading deletes:</p>
<ul>
<li>
<p><code>onDeleteInitDeleted()</code>: This works in concert with the native database
foreign <code>ON DELETE CASCADE</code> constraint. This tells Atlas to presume that the
database has deleted the related rows, and automatically re-initializes the
foreign Record in memory to a <code>DELETED</code> status.</p>
</li>
<li>
<p><code>onDeleteSetNull()</code>: When you delete the native Record, all the foreign related
Record keys for the relationship will get their values set to NULL in memory.
You will will need to actually write the related Records back to the database
for the new value to be stored; that happens automatically as part of a
<code>persist()</code> operation.</p>
</li>
<li>
<p><code>onDeleteSetDelete()</code>: When the the native Record is deleted, Atlas will call
<code>setDelete()</code> on all the foreign Records in the relationship. This will mark
the Records for deletion, but they will not actually be deleted until they
become part of a <code>persist()</code> operation (or until you delete the Record
yourself).</p>
</li>
<li>
<p><code>onDeleteCascade()</code>: When the native Record is deleted, Atlas will immediately
delete the foreign record at the database.</p>
</li>
</ul>
<p>For example, to define a relationship so that related Records are marked for
deletion automatically:</p>
<pre><code class="language-php">class FooRelationships extends MapperRelationships
{
    protected function define()
    {
        $this-&gt;oneToMany('bars', Bar::CLASS, ['foo_id' =&gt; 'foo_id'])
            -&gt;onDeleteSetDelete();
    }
}
</code></pre>
<p>When a Foo <em>Record</em> gets deleted, all of the related 'bars' in memory will
be marked for deletion as well; the 'bars' will be deleted when they become
part of a <code>persist()</code> operation:</p>
<pre><code class="language-php">// given $foo-&gt;bars ...
$foo = $atlas-&gt;fetchRecord(Foo::CLASS, ['bars']);

// ... calling delete() will delete $foo, and mark the $foo-&gt;bars
// for deletion, but will not actually delete $foo-&gt;bars from the
// database:
$atlas-&gt;delete($foo);

// ... whereas calling persist() will also delete $foo and mark
// the $foo-&gt;bars for deletion, but then continue to persist the
// related records, thus deleting the $foo-&gt;bars marked for deletion:
$atlas-&gt;persist($foo);
</code></pre>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="/cassini/orm/getting-started.html">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="/cassini/orm/reading.html">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>&copy; 2015-2021, Atlas for PHP</p>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="http://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
<script src="https://tobiju.github.io/share/prismjs/main.js"></script>
<script src="https://tobiju.github.io/share/prismjs/prism.js"></script>
<script type="text/javascript">

    function Search() {
        this.store = {};
        this.index = lunr(function () {
            this.ref('id');
            this.field('title', {boost: 10});
            this.field('content');
        });
        this.searchResults = $('.js-search-results').addClass('list-search-results');
    }

    Search.prototype = {
        constructor: Search,
        init: function () {
            this.createIndex();
            this.bindEvents();
        },
        createIndex: function () {
            var $this = this,
                indexFilePath = $('.js-search-input').data('roothref') + 'index.json';

            $.getJSON(indexFilePath, function (data) {
                $.each(data, function (key, item) {
                    $this.index.add({
                        id: item.id,
                        title: item.title,
                        content: item.content
                    });

                    $this.store[item.id] = {
                        href: item.id,
                        title: item.title,
                        content: item.content
                    }
                });
            });
        },
        bindEvents: function () {
            var $this = this;

            $('html')
                .on('click', function (event) {
                    $this.close($(this), event);
                });

            $('.js-search-input, .js-search-results')
                .on('click', function (event) {
                    $this.click($(this), event);
                });

            $('.js-search-input')
                .on('focus', function (event) {
                    $this.focus($(this), event);
                })
                .on('keyup', function (event) {
                    $this.search($(this), event)
                })
                .on('keydown', function (event) {
                    if ($('.js-search-results ul').is(':visible')){
                        $this.navigation($(this), event)
                    }
                })
        },
        click: function (element, event) {
            event.stopPropagation();
        },
        focus: function (element, event) {
            this.searchInputWidth = element.css('width');
            element.animate({
                'width': 600
            }, 500);
            $('#js-navbar-collapse > ul').fadeOut();
        },
        close: function (element, event) {
            var $this = this;

            $('.js-search-results').hide();
            $('.js-search-input').animate({
                'width': $this.searchInputWidth
            }, 500);
            $('#js-navbar-collapse > ul').fadeIn();
        },
        search: function (element, event) {
            var $this = this;

            if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40) {
                return;
            }

            var query = element.val(),
                results = $this.index.search(query);

            if (!results.length) {
                $this.searchResults.empty();
                return;
            }

            var resultsList = results.reduce(function (ul, result) {
                var item = $this.store[result.ref];
                var title = $('<b>').text(item.title);

                var cropText = $this.cropText(item.content, query);
                if (cropText.length === 0) {
                    cropText = $('<p>').html(item.content.substring(0, 120) + "...");
                }
                var content = content = $('<p>').html(cropText);

                var div = $('<div>')
                    .append(title)
                    .append(content);
                var a = $('<a>').attr('href', item.href)
                    .append(div);
                var li = $('<li>')
                    .append(a);
                ul.append(li);

                return ul;
            }, $('<ul>'));

            this.searchResults.html(resultsList);

            $('.js-search-results').show();
            $(".js-search-results li:first-child").addClass('selected');
        },
        cropText: function (content, query) {
            var cropedText = '',
                re = new RegExp("\\s?(.{0,30})?" + query + ".*?\\b(.{0,30}.)?\\s?", "gi");

            $.each(content.match(re), function (key, value) {
                cropedText += '...' + value + '...';
            });

            return cropedText;
        },
        navigation: function (element, event) {
            var selected = null,
                listSelector = ".js-search-results ul",
                listItemSelector = listSelector + " li",
                selectedListItemSelector = listItemSelector + ".selected",
                selectedListItemSelectorAnchor = listItemSelector + ".selected a";

            // enter
            if (event.keyCode == 13) {
                event.preventDefault();
                this.close();
                window.location.replace($(selectedListItemSelectorAnchor).attr('href'));
            }

            // up
            if (event.keyCode == 38) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.prev().length == 0) {
                    selected.siblings().last().addClass("selected");
                } else {
                    selected.prev().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListUp(selected);
            }

            // down
            if (event.keyCode == 40) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.next().length == 0) {
                    selected.siblings().first().addClass("selected");
                } else {
                    selected.next().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListDown(selected);
            }
        },
        scrollListDown: function (element) {
            var ul = element.parent(),
                ulHeight = ul.height(),
                ulBottomPosition = ulHeight + ul.scrollTop(),
                liBottomPosition = element.position().top + element.height();

            if (liBottomPosition > ulBottomPosition) {
                ul.scrollTop(liBottomPosition - ulHeight);
            }

            if (element.is(':first-child')) {
                ul.scrollTop(0);
            }
        },
        scrollListUp: function (element) {
            var ul = element.parent(),
                ulTopPosition = ul.scrollTop(),
                liTopPosition = element.position().top;

            if (liTopPosition < ulTopPosition) {
                ul.scrollTop(element.position().top);
            }

            if (element.is(':last-child')) {
                ul.scrollTop(element.position().top - element.height());
            }
        }
    };

    $(function () {
        var search = new Search();
        search.init();
    });
</script>
</body>
</html>

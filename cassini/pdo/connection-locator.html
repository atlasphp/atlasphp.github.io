<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="HandheldFriendly" content="True"/>
<title>Connection Locator</title>
    
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/cerulean/bootstrap.min.css" />
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
<link rel="stylesheet" href="https://tobiju.github.io/share/prismjs/prism-base16-ateliersulphurpool.light.css" />
<link rel="stylesheet" href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css" />
<link rel="stylesheet" href="/style.css" />
</head>
<body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-cerulean">
<div class="page-wrapper">
    <header>
    
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="box-header container">
        <form class="form-search navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text"
                       placeholder="Search"
                       class="js-search-input form-control"
                       data-roothref="/">

                <div class="js-search-results"></div>
            </div>
        </form>

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
                            <a class="navbar-brand" href="/">
                    <img alt="logo" src="https://raw.githubusercontent.com/atlasphp/atlasphp.github.io/master/images/atlas.png" title="Home">
                </a>
                    </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
                        <li>
    <a href="/cassini/">Cassini (v3)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/orm/">ORM</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/orm/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/cassini/orm/relationships.html">Mapper Relationships</a>

    </li>
                        <li>
    <a href="/cassini/orm/reading.html">Fetching Records and RecordSets</a>

    </li>
                        <li>
    <a href="/cassini/orm/records.html">Working with Records</a>

    </li>
                        <li>
    <a href="/cassini/orm/record-sets.html">Working with RecordSets</a>

    </li>
                        <li>
    <a href="/cassini/orm/transactions.html">Transactions</a>

    </li>
                        <li>
    <a href="/cassini/orm/behavior.html">Record and RecordSet Behaviors</a>

    </li>
                        <li>
    <a href="/cassini/orm/events.html">Events</a>

    </li>
                        <li>
    <a href="/cassini/orm/direct.html">Direct Queries</a>

    </li>
                        <li>
    <a href="/cassini/orm/other.html">Other Topics</a>

    </li>
                        <li>
    <a href="/cassini/orm/domain.html">Domain Models</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/skeleton/">Skeleton Generator</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/skeleton/usage.html">Usage</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/table/">Table Data Gateway</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/table/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/cassini/table/reading.html">Reading From The Table</a>

    </li>
                        <li>
    <a href="/cassini/table/writing.html">Writing To The Table</a>

    </li>
                        <li>
    <a href="/cassini/table/events.html">Table Events</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/query/">Query System</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/query/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/cassini/query/binding.html">Value Binding</a>

    </li>
                        <li>
    <a href="/cassini/query/select.html">SELECT</a>

    </li>
                        <li>
    <a href="/cassini/query/insert.html">INSERT</a>

    </li>
                        <li>
    <a href="/cassini/query/update.html">UPDATE</a>

    </li>
                        <li>
    <a href="/cassini/query/delete.html">DELETE</a>

    </li>
                        <li>
    <a href="/cassini/query/other.html">Other Topics</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/info/">Schema Information</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/info/usage.html">Usage</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/pdo/">PDO Connection</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/pdo/connection.html">PDO Connection</a>

    </li>
                        <li>
    <a href="/cassini/pdo/connection-locator.html">Connection Locator</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/boggs/">Boggs (v2)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/boggs/mapper/">ORM</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/boggs/mapper/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/boggs/mapper/relationships.html">Mapper Relationships</a>

    </li>
                        <li>
    <a href="/boggs/mapper/reading.html">Fetching Records and RecordSets</a>

    </li>
                        <li>
    <a href="/boggs/mapper/records.html">Working with Records</a>

    </li>
                        <li>
    <a href="/boggs/mapper/record-sets.html">Working with RecordSets</a>

    </li>
                        <li>
    <a href="/boggs/mapper/transactions.html">Transactions (Unit of Work)</a>

    </li>
                        <li>
    <a href="/boggs/mapper/behavior.html">Record and RecordSet Behaviors</a>

    </li>
                        <li>
    <a href="/boggs/mapper/events.html">Events</a>

    </li>
                        <li>
    <a href="/boggs/mapper/direct.html">Direct Queries</a>

    </li>
                        <li>
    <a href="/boggs/mapper/domain.html">Domain Models</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/boggs/skeleton/">Skeleton Generator</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/boggs/skeleton/getting-started.html">Atlas.Cli 1.x</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/albers/">Albers (v1)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/albers/mapper/">ORM</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/albers/mapper/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/albers/mapper/relationships.html">Mapper Relationships</a>

    </li>
                        <li>
    <a href="/albers/mapper/reading.html">Fetching Records and RecordSets</a>

    </li>
                        <li>
    <a href="/albers/mapper/records.html">Working with Records</a>

    </li>
                        <li>
    <a href="/albers/mapper/record-sets.html">Working with RecordSets</a>

    </li>
                        <li>
    <a href="/albers/mapper/transactions.html">Transactions (Unit of Work)</a>

    </li>
                        <li>
    <a href="/albers/mapper/behavior.html">Record and RecordSet Behaviors</a>

    </li>
                        <li>
    <a href="/albers/mapper/events.html">Events</a>

    </li>
                        <li>
    <a href="/albers/mapper/direct.html">Direct Queries</a>

    </li>
                        <li>
    <a href="/albers/mapper/domain.html">Domain Models</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/albers/skeleton/">Skeleton Generator</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/albers/skeleton/getting-started.html">Atlas.Cli 1.x</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <ol class="breadcrumb">
                        <li><a href="/">Atlas Database Framework for PHP</a></li>
                                <li><a href="/cassini/">Cassini (v3)</a></li>
                                <li><a href="/cassini/pdo/">PDO Connection</a></li>
                                <li class="active">Connection Locator</li>
            </ol>
    <div class="row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#1-6-2" title="Connection&#x20;Locator">Connection Locator</a>
            </li>
                                <li>
                <a href="#1-6-2-1" title="Instantiation">Instantiation</a>
            </li>
                                <li>
                <a href="#1-6-2-2" title="Runtime&#x20;Configuration">Runtime Configuration</a>
            </li>
                                <li>
                <a href="#1-6-2-3" title="Getting&#x20;Connections">Getting Connections</a>
            </li>
                                <li>
                <a href="#1-6-2-4" title="Locking&#x20;To&#x20;The&#x20;Write&#x20;Connection">Locking To The Write Con...</a>
            </li>
                                <li>
                <a href="#1-6-2-5" title="Construction-Time&#x20;Configuration">Construction-Time Config...</a>
            </li>
                                <li>
                <a href="#1-6-2-6" title="Query&#x20;Logging">Query Logging</a>
            </li>
            </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="1-6-2">1.6.2. Connection Locator</h1>
<p>Some applications may use multiple database servers; for example, one for writes, and one or more for reads. The <em>ConnectionLocator</em> allows you to define multiple <em>Connection</em> objects for lazy-loaded read and write connections. It will create the connections only when they are when called. The <em>Connection</em> creation logic should be wrapped in factory callable.</p>
<h2 id="1-6-2-1">1.6.2.1. Instantiation</h2>
<p>The easiest way to create a <em>ConnectionLoctor</em> is to use its static  <code>new()</code> method, either with <em>PDO</em> connection arguments, or with an actual <em>PDO</em> instance:</p>
<pre><code class="language-php">use Atlas\Pdo\ConnectionLocator;

// pass PDO constructor arguments ...
$connectionLocator = ConnectionLocator::new(
    'mysql:host=localhost;dbname=testdb',
    'username',
    'password'
);

// ... or a PDO instance.
$connectionLocator = ConnectionLocator::new($pdo);
</code></pre>
<p>Doing so will define the default connection factory for the <em>ConnectionLocator</em>.</p>
<h2 id="1-6-2-2">1.6.2.2. Runtime Configuration</h2>
<p>Once you have a <em>ConnectionLocator</em>, you can add as many named read and write connection factories as you like:</p>
<pre><code class="language-php">// the write (master) server
$connectionLocator-&gt;setWriteFactory('master', Connection::factory(
    'mysql:host=master.db.localhost;dbname=database',
    'username',
    'password'
));

// read (slave) #1
$connectionLocator-&gt;setReadFactory('slave1', Connection::factory(
    return new Connection(
        'mysql:host=slave1.db.localhost;dbname=database',
        'username',
        'password'
    );
});

// read (slave) #2
$connectionLocator-&gt;setReadFactory('slave2', Connection::factory(
    'mysql:host=slave2.db.localhost;dbname=database',
    'username',
    'password'
));

// read (slave) #3
$connectionLocator-&gt;setReadFactory('slave3', Connection::factory(
    'mysql:host=slave3.db.localhost;dbname=database',
    'username',
    'password'
));
</code></pre>
<h2 id="1-6-2-3">1.6.2.3. Getting Connections</h2>
<p>Retrieve a <em>Connection</em> from the locator when you need it. This will create the <em>Connection</em> (if needed) and then return it.</p>
<ul>
<li>
<p><code>getDefault()</code> will return the default <em>Connection</em>.</p>
</li>
<li>
<p><code>getRead()</code> will return a random read <em>Connection</em>; after the first call, <code>getRead()</code> will always return the same <em>Connection</em>. (If no read <em>Connections</em> are defined, it will return the default connection.)</p>
</li>
<li>
<p><code>getWrite()</code> will return a random write <em>Connection</em>; after the first call, <code>getWrite()</code> will always return the same <em>Connection</em>. (If no read <em>Connections</em> are defined, it will return the default connection.)</p>
</li>
</ul>
<pre><code class="language-php">$read = $connectionLocator-&gt;getRead();
$results = $read-&gt;fetchAll('SELECT * FROM table_name LIMIT 10');

$readAgain = $connectionLocator-&gt;getRead();
assert($read === $readAgain); // true
</code></pre>
<p>You can get any read or write connection directly by name using the <code>get()</code> method:</p>
<pre><code class="language-php">$foo = $connectionLocator-&gt;get(ConnectionLocator::READ, 'foo');
$bar = $connectionLocator-&gt;get(ConnectionLocator::WRITE, 'bar');
</code></pre>
<h2 id="1-6-2-4">1.6.2.4. Locking To The Write Connection</h2>
<p>If you call the <code>lockToWrite()</code> method, calls to <code>getRead()</code> will return the write connection instead of the read connection.</p>
<pre><code class="language-php">$read = $connectionLocator-&gt;getRead();
$write = $connectionLocator-&gt;getWrite();

$connectionLocator-&gt;lockToWrite();
$readAgain = $connectionLocator-&gt;getRead();
assert($readAgain === $write); // true
</code></pre>
<p>You can disable the lock-to-write behavior by calling <code>lockToWrite(false)</code>.</p>
<h2 id="1-6-2-5">1.6.2.5. Construction-Time Configuration</h2>
<p>The <em>ConnectionLocator</em> can be configured with all its connections at construction time; this can be useful with dependency injection mechanisms. (Note that this requires using the constructor proper, not the static <code>new()</code> method.)</p>
<pre><code class="language-php">use Atlas\Pdo\Connection;
use Atlas\Pdo\ConnectionLocator;

// default connection
$default = Connection::factory(
    'mysql:host=default.db.localhost;dbname=database',
    'username',
    'password'
);

// read connections
$read = [
    'slave1' =&gt; Connection::factory(
        'mysql:host=slave1.db.localhost;dbname=database',
        'username',
        'password'
    ),
    'slave2' =&gt; Connection::factory(
        'mysql:host=slave2.db.localhost;dbname=database',
        'username',
        'password'
    ),
    'slave3' =&gt; Connection::factory(
        'mysql:host=slave3.db.localhost;dbname=database',
        'username',
        'password'
    ),
];

// write connection
$write = [
    'master' =&gt; Connection::factory(
        'mysql:host=master.db.localhost;dbname=database',
        'username',
        'password'
    ),
];

// configure locator at construction time
$connectionLocator = new ConnectionLocator($default, $read, $write);
</code></pre>
<h2 id="1-6-2-6">1.6.2.6. Query Logging</h2>
<p>As with an individual <em>Connection</em>, it is sometimes useful to log all
queries on all connections in the <em>ConnectionLocator</em>. To do so, call its
<code>logQueries()</code> method, issue your queries, and then call <code>getQueries()</code> to
get back the log entries.</p>
<pre><code class="language-php">// start logging
$connectionLocator-&gt;logQueries(true);

// retrieve connections and issue queries, then:
$queries = $connectionLocator-&gt;getQueries();

// stop logging
$connectionLocator-&gt;logQueries(false);
</code></pre>
<p>Each query log entry will have one added key, <code>connection</code>, indicating which
connection performed the query. The <code>connection</code> label will be <code>DEFAULT</code> for the
default connection, <code>READ:</code> and the read connection name, or <code>WRITE:</code> and the
write connection name.</p>
<blockquote>
<p><strong>Note:</strong></p>
<p>Calling <code>logQueries()</code> will turn logging on and off for all instances in the
locator, even if those instances are not "in hand" at the moment. That is,
you do not have to re-get the instance; logging for each connection will be
turned on and off "at a distance."</p>
</blockquote>
<p>You may wish to set a custom logger on the <em>ConnectionLocator</em>. To do so, call
<code>setQueryLogger()</code> and pass a callable with the signature
<code>function (array $entry) : void</code>.</p>
<pre><code class="language-php">class CustomDebugger
{
    public function __invoke(array $entry) : void
    {
        // call an injected logger to record the entry
    }
}

$customDebugger = new CustomDebugger();
$connectionLocator-&gt;setQueryLogger($customDebugger);
$connectionLocator-&gt;logQueries(true);

// now the Connection will send query log entries to the CustomDebugger
</code></pre>
<blockquote>
<p><strong>Note:</strong></p>
<p>If you set a custom logger, the <em>Connection</em> will no longer retain its own
query log entries; they will all go to the custom logger. This means that
<code>getQueries()</code> on the <em>Connection</em> not show any new entries.</p>
</blockquote>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="/cassini/pdo/connection.html">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="/boggs/">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>&copy; 2015-2018, Atlas for PHP</p>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="http://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
<script src="https://tobiju.github.io/share/prismjs/main.js"></script>
<script src="https://tobiju.github.io/share/prismjs/prism.js"></script>
<script type="text/javascript">

    function Search() {
        this.store = {};
        this.index = lunr(function () {
            this.ref('id');
            this.field('title', {boost: 10});
            this.field('content');
        });
        this.searchResults = $('.js-search-results').addClass('list-search-results');
    }

    Search.prototype = {
        constructor: Search,
        init: function () {
            this.createIndex();
            this.bindEvents();
        },
        createIndex: function () {
            var $this = this,
                indexFilePath = $('.js-search-input').data('roothref') + 'index.json';

            $.getJSON(indexFilePath, function (data) {
                $.each(data, function (key, item) {
                    $this.index.add({
                        id: item.id,
                        title: item.title,
                        content: item.content
                    });

                    $this.store[item.id] = {
                        href: item.id,
                        title: item.title,
                        content: item.content
                    }
                });
            });
        },
        bindEvents: function () {
            var $this = this;

            $('html')
                .on('click', function (event) {
                    $this.close($(this), event);
                });

            $('.js-search-input, .js-search-results')
                .on('click', function (event) {
                    $this.click($(this), event);
                });

            $('.js-search-input')
                .on('focus', function (event) {
                    $this.focus($(this), event);
                })
                .on('keyup', function (event) {
                    $this.search($(this), event)
                })
                .on('keydown', function (event) {
                    if ($('.js-search-results ul').is(':visible')){
                        $this.navigation($(this), event)
                    }
                })
        },
        click: function (element, event) {
            event.stopPropagation();
        },
        focus: function (element, event) {
            this.searchInputWidth = element.css('width');
            element.animate({
                'width': 600
            }, 500);
            $('#js-navbar-collapse > ul').fadeOut();
        },
        close: function (element, event) {
            var $this = this;

            $('.js-search-results').hide();
            $('.js-search-input').animate({
                'width': $this.searchInputWidth
            }, 500);
            $('#js-navbar-collapse > ul').fadeIn();
        },
        search: function (element, event) {
            var $this = this;

            if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40) {
                return;
            }

            var query = element.val(),
                results = $this.index.search(query);

            if (!results.length) {
                $this.searchResults.empty();
                return;
            }

            var resultsList = results.reduce(function (ul, result) {
                var item = $this.store[result.ref];
                var title = $('<b>').text(item.title);

                var cropText = $this.cropText(item.content, query);
                if (cropText.length === 0) {
                    cropText = $('<p>').html(item.content.substring(0, 120) + "...");
                }
                var content = content = $('<p>').html(cropText);

                var div = $('<div>')
                    .append(title)
                    .append(content);
                var a = $('<a>').attr('href', item.href)
                    .append(div);
                var li = $('<li>')
                    .append(a);
                ul.append(li);

                return ul;
            }, $('<ul>'));

            this.searchResults.html(resultsList);

            $('.js-search-results').show();
            $(".js-search-results li:first-child").addClass('selected');
        },
        cropText: function (content, query) {
            var cropedText = '',
                re = new RegExp("\\s?(.{0,30})?" + query + ".*?\\b(.{0,30}.)?\\s?", "gi");

            $.each(content.match(re), function (key, value) {
                cropedText += '...' + value + '...';
            });

            return cropedText;
        },
        navigation: function (element, event) {
            var selected = null,
                listSelector = ".js-search-results ul",
                listItemSelector = listSelector + " li",
                selectedListItemSelector = listItemSelector + ".selected",
                selectedListItemSelectorAnchor = listItemSelector + ".selected a";

            // enter
            if (event.keyCode == 13) {
                event.preventDefault();
                this.close();
                window.location.replace($(selectedListItemSelectorAnchor).attr('href'));
            }

            // up
            if (event.keyCode == 38) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.prev().length == 0) {
                    selected.siblings().last().addClass("selected");
                } else {
                    selected.prev().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListUp(selected);
            }

            // down
            if (event.keyCode == 40) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.next().length == 0) {
                    selected.siblings().first().addClass("selected");
                } else {
                    selected.next().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListDown(selected);
            }
        },
        scrollListDown: function (element) {
            var ul = element.parent(),
                ulHeight = ul.height(),
                ulBottomPosition = ulHeight + ul.scrollTop(),
                liBottomPosition = element.position().top + element.height();

            if (liBottomPosition > ulBottomPosition) {
                ul.scrollTop(liBottomPosition - ulHeight);
            }

            if (element.is(':first-child')) {
                ul.scrollTop(0);
            }
        },
        scrollListUp: function (element) {
            var ul = element.parent(),
                ulTopPosition = ul.scrollTop(),
                liTopPosition = element.position().top;

            if (liTopPosition < ulTopPosition) {
                ul.scrollTop(element.position().top);
            }

            if (element.is(':last-child')) {
                ul.scrollTop(element.position().top - element.height());
            }
        }
    };

    $(function () {
        var search = new Search();
        search.init();
    });
</script>
</body>
</html>

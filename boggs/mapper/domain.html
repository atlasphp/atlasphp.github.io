<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="HandheldFriendly" content="True"/>
<title>Domain Models</title>
    
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/cerulean/bootstrap.min.css" />
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
<link rel="stylesheet" href="https://tobiju.github.io/share/prismjs/prism-base16-ateliersulphurpool.light.css" />
<link rel="stylesheet" href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css" />
<link rel="stylesheet" href="/style.css" />
</head>
<body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-cerulean">
<div class="page-wrapper">
    <header>
    
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="box-header container">
        <form class="form-search navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text"
                       placeholder="Search"
                       class="js-search-input form-control"
                       data-roothref="/">

                <div class="js-search-results"></div>
            </div>
        </form>

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
                            <a class="navbar-brand" href="/">
                    <img alt="logo" src="https://raw.githubusercontent.com/atlasphp/atlasphp.github.io/master/images/atlas.png" title="Home">
                </a>
                    </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
                        <li>
    <a href="/dymaxion/">Dymaxion (v4)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/dymaxion/pdo/">PDO Connection</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/dymaxion/pdo/connection.html">PDO Connection</a>

    </li>
                        <li>
    <a href="/dymaxion/pdo/connection-locator.html">Connection Locator</a>

    </li>
                        <li>
    <a href="/dymaxion/pdo/upgrade.html">Upgrade Notes</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/dymaxion/statement/">Query Statement Builders</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/dymaxion/statement/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/binding.html">Value Binding</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/ctes.html">Common Table Expressions</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/select.html">SELECT</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/insert.html">INSERT</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/update.html">UPDATE</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/delete.html">DELETE</a>

    </li>
                        <li>
    <a href="/dymaxion/statement/other.html">Other Topics</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/dymaxion/query/">Query Statement Performers</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/dymaxion/query/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/dymaxion/query/execution.html">Query Execution</a>

    </li>
                        <li>
    <a href="/dymaxion/query/upgrade.html">Upgrade Notes</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/">Cassini (v3)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/orm/">ORM</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/orm/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/cassini/orm/relationships.html">Mapper Relationships</a>

    </li>
                        <li>
    <a href="/cassini/orm/reading.html">Fetching Records and RecordSets</a>

    </li>
                        <li>
    <a href="/cassini/orm/records.html">Working with Records</a>

    </li>
                        <li>
    <a href="/cassini/orm/record-sets.html">Working with RecordSets</a>

    </li>
                        <li>
    <a href="/cassini/orm/transactions.html">Transactions</a>

    </li>
                        <li>
    <a href="/cassini/orm/behavior.html">Record and RecordSet Behaviors</a>

    </li>
                        <li>
    <a href="/cassini/orm/events.html">Events</a>

    </li>
                        <li>
    <a href="/cassini/orm/direct.html">Direct Queries</a>

    </li>
                        <li>
    <a href="/cassini/orm/other.html">Other Topics</a>

    </li>
                        <li>
    <a href="/cassini/orm/domain.html">Domain Models</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/skeleton/">Skeleton Generator</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/skeleton/usage.html">Usage</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/table/">Table Data Gateway</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/table/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/cassini/table/reading.html">Reading From The Table</a>

    </li>
                        <li>
    <a href="/cassini/table/writing.html">Writing To The Table</a>

    </li>
                        <li>
    <a href="/cassini/table/events.html">Table Events</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/query/">Query System</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/query/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/cassini/query/binding.html">Value Binding</a>

    </li>
                        <li>
    <a href="/cassini/query/select.html">SELECT</a>

    </li>
                        <li>
    <a href="/cassini/query/insert.html">INSERT</a>

    </li>
                        <li>
    <a href="/cassini/query/update.html">UPDATE</a>

    </li>
                        <li>
    <a href="/cassini/query/delete.html">DELETE</a>

    </li>
                        <li>
    <a href="/cassini/query/other.html">Other Topics</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/info/">Schema Information</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/info/usage.html">Usage</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/pdo/">PDO Connection</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/pdo/connection.html">PDO Connection</a>

    </li>
                        <li>
    <a href="/cassini/pdo/connection-locator.html">Connection Locator</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/boggs/">Boggs (v2)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/boggs/mapper/">ORM</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/boggs/mapper/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/boggs/mapper/relationships.html">Mapper Relationships</a>

    </li>
                        <li>
    <a href="/boggs/mapper/reading.html">Fetching Records and RecordSets</a>

    </li>
                        <li>
    <a href="/boggs/mapper/records.html">Working with Records</a>

    </li>
                        <li>
    <a href="/boggs/mapper/record-sets.html">Working with RecordSets</a>

    </li>
                        <li>
    <a href="/boggs/mapper/transactions.html">Transactions (Unit of Work)</a>

    </li>
                        <li>
    <a href="/boggs/mapper/behavior.html">Record and RecordSet Behaviors</a>

    </li>
                        <li>
    <a href="/boggs/mapper/events.html">Events</a>

    </li>
                        <li>
    <a href="/boggs/mapper/direct.html">Direct Queries</a>

    </li>
                        <li>
    <a href="/boggs/mapper/domain.html">Domain Models</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/boggs/skeleton/">Skeleton Generator</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/boggs/skeleton/getting-started.html">Atlas.Cli 1.x</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/albers/">Albers (v1)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/albers/mapper/">ORM</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/albers/mapper/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/albers/mapper/relationships.html">Mapper Relationships</a>

    </li>
                        <li>
    <a href="/albers/mapper/reading.html">Fetching Records and RecordSets</a>

    </li>
                        <li>
    <a href="/albers/mapper/records.html">Working with Records</a>

    </li>
                        <li>
    <a href="/albers/mapper/record-sets.html">Working with RecordSets</a>

    </li>
                        <li>
    <a href="/albers/mapper/transactions.html">Transactions (Unit of Work)</a>

    </li>
                        <li>
    <a href="/albers/mapper/behavior.html">Record and RecordSet Behaviors</a>

    </li>
                        <li>
    <a href="/albers/mapper/events.html">Events</a>

    </li>
                        <li>
    <a href="/albers/mapper/direct.html">Direct Queries</a>

    </li>
                        <li>
    <a href="/albers/mapper/domain.html">Domain Models</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/albers/skeleton/">Skeleton Generator</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/albers/skeleton/getting-started.html">Atlas.Cli 1.x</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <ol class="breadcrumb">
                        <li><a href="/">Atlas Database Framework for PHP</a></li>
                                <li><a href="/boggs/">Boggs (v2)</a></li>
                                <li><a href="/boggs/mapper/">ORM</a></li>
                                <li class="active">Domain Models</li>
            </ol>
    <div class="row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#3-1-10" title="Domain&#x20;Models">Domain Models</a>
            </li>
                                <li>
                <a href="#3-1-10-1" title="Persistence&#x20;Model">Persistence Model</a>
            </li>
                                <li>
                <a href="#3-1-10-2" title="Domain&#x20;Model&#x20;Interfaces">Domain Model Interfaces</a>
            </li>
                                <li>
                <a href="#3-1-10-3" title="Implement&#x20;Domain&#x20;In&#x20;Persistence">Implement Domain In Pers...</a>
            </li>
                                <li>
                <a href="#3-1-10-4" title="Compose&#x20;Persistence&#x20;Into&#x20;Domain">Compose Persistence Into...</a>
            </li>
                                <li>
                <a href="#3-1-10-5" title="Map&#x20;From&#x20;Persistence&#x20;To&#x20;Domain">Map From Persistence To ...</a>
            </li>
                                <li>
                <a href="#3-1-10-6" title="Which&#x20;Approach&#x20;Is&#x20;Best&#x3F;">Which Approach Is Best?</a>
            </li>
            </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="3-1-10">3.1.10. Domain Models</h1>
<p>You can go a long way with just your persistence model Records. However, at some
point you may want to separate your persistence model Records from your domain
model Entities and Aggregates. This section offers some suggestions and examples
on how to do that.</p>
<h2 id="3-1-10-1">3.1.10.1. Persistence Model</h2>
<p>For the examples below, we will work with an imaginary forum application that
has conversation threads. The ThreadMapper might something like this:</p>
<pre><code class="language-php">&lt;?php
namespace App\DataSource\Thread;

use App\DataSource\Author\AuthorMapper;
use App\DataSource\Summary\SummaryMapper;
use App\DataSource\Reply\ReplyMapper;
use App\DataSource\Tagging\TaggingMapper;
use App\DataSource\Tag\TagMapper;
use Atlas\Orm\Mapper\AbstractMapper;

class ThreadMapper extends AbstractMapper
{
    protected function setRelated()
    {
        $this-&gt;manyToOne('author', AuthorMapper::CLASS);
        $this-&gt;oneToOne('summary', SummaryMapper::CLASS);
        $this-&gt;oneToMany('replies', ReplyMapper::CLASS);
        $this-&gt;oneToMany('taggings', TaggingMapper::CLASS);
        $this-&gt;manyToMany('tags', TagMapper::CLASS, 'taggings');
    }
}
</code></pre>
<p>(We will leave the other mappers and their record classes for the imagination.)</p>
<h2 id="3-1-10-2">3.1.10.2. Domain Model Interfaces</h2>
<p>At some point, we have decided we want to depend on domain Entities or
Aggregates, rather than persistence Records, in our application.</p>
<p>For example, the interface we want to use for a Thread Entity in domain might
look like this:</p>
<pre><code class="language-php">&lt;?php
namespace App\Domain\Thread;

interface ThreadInterface
{
    public function getId();
    public function getSubject();
    public function getBody();
    public function getDatePublished();
    public function getAuthorId();
    public function getAuthorName();
    public function getTags();
    public function getReplies();
}
</code></pre>
<p>(This interface allows us to typehint the application against these domain-
specific Entity methods, rather than using the persistence Record properties.)</p>
<p>Further, we will presume a naive domain repository implementation that returns
Thread Entities. It might look something like this:</p>
<pre><code class="language-php">&lt;?php
namespace App\Domain\Thread;

use App\DataSource\Thread\ThreadMapper;

class ThreadRepository
{
    protected $mapper;

    public function __construct(ThreadMapper $mapper)
    {
        $this-&gt;mapper = $mapper;
    }

    public function fetchThread($thread_id)
    {
        $record = $this-&gt;mapper-&gt;fetchRecord($thread_id, [
            'author',
            'taggings',
            'tags',
            'replies',
        ]);

        return $this-&gt;newThread($record);
    }

    protected function newThread(ThreadRecord $record)
    {
        /* ??? */
    }
}
</code></pre>
<p>The problem now is the <code>newThread()</code> factory method. How do we convert a
persistence layer ThreadRecord into a domain layer ThreadInterface
implementation?</p>
<p>There are three options, each with different tradeoffs:</p>
<ol>
<li>Implement the domain interface in the persistence layer.</li>
<li>Compose the persistence record into the domain object.</li>
<li>Map the persistence record fields to domain implementation fields.</li>
</ol>
<h2 id="3-1-10-3">3.1.10.3. Implement Domain In Persistence</h2>
<p>The easiest thing to do is to implement the domain ThreadInterface in the
persistence ThreadRecord, like so:</p>
<pre><code class="language-php">&lt;?php
namespace App\DataSource\Thread;

use Atlas\Orm\Mapper\Record;
use App\Domain\Thread\ThreadInterface;

class ThreadRecord extends Record implements ThreadInterface
{
    public function getId()
    {
        return $this-&gt;thread_id;
    }

    public function getTitle()
    {
        return $this-&gt;title;
    }

    public function getBody()
    {
        return $this-&gt;body;
    }

    public function getDatePublished()
    {
        return $this-&gt;date_published;
    }

    public function getAuthorId()
    {
        return $this-&gt;author-&gt;author_id;
    }

    public function getAuthorName()
    {
        return $this-&gt;author-&gt;name;
    }

    public function getTags()
    {
        return $this-&gt;tags-&gt;getArrayCopy();
    }

    public function getReplies()
    {
        return $this-&gt;replies-&gt;getArrayCopy();
    }
}
</code></pre>
<p>With this, the <code>ThreadRepository::newThread()</code> factory method doesn't actually
need to factory anything at all. It just returns the persistence record, since
the record now has the domain interface.</p>
<pre><code class="language-php">&lt;?php
class ThreadRepository ...

    protected function newThread(ThreadRecord $record)
    {
        return $record;
    }
</code></pre>
<p>Pros:</p>
<ul>
<li>Trivial to implement.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Exposes the persistence layer Record methods and properties to the domain
layer, where they can be easily abused.</li>
</ul>
<h2 id="3-1-10-4">3.1.10.4. Compose Persistence Into Domain</h2>
<p>Almost as easy, but with better separation, is to have a domain layer object
that implements the domain interface, but encapsulates the persistence record
as the data source. The domain object might look something like this:</p>
<pre><code class="language-php">&lt;?php
namespace App\Domain\Thread;

use App\DataSource\Thread\ThreadRecord;

class Thread implements ThreadInterface
{
    protected $record;

    public function __construct(ThreadRecord $record)
    {
        $this-&gt;record = $record;
    }

    public function getId()
    {
        return $this-&gt;record-&gt;thread_id;
    }

    public function getTitle()
    {
        return $this-&gt;record-&gt;title;
    }

    public function getBody()
    {
        return $this-&gt;record-&gt;body;
    }

    public function getDatePublished()
    {
        return $this-&gt;record-&gt;date_published;
    }

    public function getAuthorId()
    {
        return $this-&gt;record-&gt;author-&gt;author_id;
    }

    public function getAuthorName()
    {
        return $this-&gt;record-&gt;author-&gt;name;
    }

    public function getTags()
    {
        return $this-&gt;record-&gt;tags-&gt;getArrayCopy();
    }

    public function getReplies()
    {
        return $this-&gt;record-&gt;replies-&gt;getArrayCopy();
    }
}
</code></pre>
<p>Now the <code>ThreadRepository::newThread()</code> factory method has to do a little work,
but not much. All it needs is to create the Thread domain object with the
ThreadRecord as a constructor dependency.</p>
<pre><code class="language-php">&lt;?php
class ThreadRepository ...

    protected function newThread(ThreadRecord $record)
    {
        return new Thread($record);
    }
</code></pre>
<p>Pros:</p>
<ul>
<li>Hides the persistence record behind the domain interface.</li>
<li>Easy to implement.</li>
</ul>
<p>Cons:</p>
<ul>
<li>The domain object is now dependent on the persistence layer, which is not the
direction of dependencies we'd prefer.</li>
</ul>
<h2 id="3-1-10-5">3.1.10.5. Map From Persistence To Domain</h2>
<p>Most difficult, but with the best separation, is to map the individual parts of
the persistence record over to a "plain old PHP object" (POPO) in the domain,
perhaps something like the following:</p>
<pre><code class="language-php">&lt;?php
namespace App\Domain\Thread;

class Thread implements ThreadInterface
{
    protected $id;
    protected $title;
    protected $body;
    protected $datePublished;
    protected $authorId;
    protected $authorName;
    protected $tags;
    protected $replies;

    public function __construct(
        $id,
        $title,
        $body,
        $datePublished,
        $authorId,
        $authorName,
        array $tags,
        array $replies
    ) {
        $this-&gt;id = $id;
        $this-&gt;title = $title;
        $this-&gt;body = $body;
        $this-&gt;datePublished = $datePublished;
        $this-&gt;authorId = $authorId;
        $this-&gt;authorName = $authorName;
        $this-&gt;tags = $tags;
        $this-&gt;replies = $replies;
    }

    public function getId()
    {
        return $this-&gt;id;
    }

    public function getTitle()
    {
        return $this-&gt;title;
    }

    public function getBody()
    {
        return $this-&gt;body;
    }

    public function getDatePublished()
    {
        return $this-&gt;datePublished;
    }

    public function getAuthorId()
    {
        return $this-&gt;authorId;
    }

    public function getAuthorName()
    {
        return $this-&gt;authorName;
    }

    public function getTags()
    {
        return $this-&gt;tags;
    }

    public function getReplies()
    {
        return $this-&gt;replies;
    }
}
</code></pre>
<p>Now the <code>ThreadRepository::newThread()</code> factory method has a lot of work to do.
It needs to map the individual fields in the persistence record to the domain
object properties.</p>
<pre><code class="language-php">&lt;?php
class ThreadRepository ...

    protected function newThread(ThreadRecord $record)
    {
        return new Thread(
            $record-&gt;thread_id,
            $record-&gt;title,
            $record-&gt;body,
            $record-&gt;date_published,
            $record-&gt;author-&gt;author_id,
            $record-&gt;author-&gt;name,
            $record-&gt;tags-&gt;getArrayCopy(),
            $record-&gt;replies-&gt;getArrayCopy()
        );
    }

</code></pre>
<p>Pros:</p>
<ul>
<li>Offers true separation of domain from persistence.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Tedious and time-consuming to implement.</li>
</ul>
<h2 id="3-1-10-6">3.1.10.6. Which Approach Is Best?</h2>
<p>"It depends." What does it depend on?  How much time you have available, and what kind of
suffering you are willing to put up with.</p>
<p>If you need something quick, fast, and in a hurry, implementing the domain
interface in the persistence layer will do the trick. However, it will come back
to bite in you just as quickly, as you begin to realize that you need different
domain behaviors in different contexts, all built from the same backing
persistence records.</p>
<p>If you are willing to deal with the trouble that comes from depending on the
persistence layer records inside your domain, and the possibility that other
developers will expose the underlying record in subtle ways, then composing the
record into the domain may be your best bet.</p>
<p>The most formally-correct approach is to map the record fields over to domain
object properties. This level of separation makes testing and modification of
application logic much easier in the long run, but it takes a lot of time,
attention, and discipline.</p>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="/boggs/mapper/direct.html">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="/boggs/skeleton/">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>&copy; 2015-2021, Atlas for PHP</p>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="http://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
<script src="https://tobiju.github.io/share/prismjs/main.js"></script>
<script src="https://tobiju.github.io/share/prismjs/prism.js"></script>
<script type="text/javascript">

    function Search() {
        this.store = {};
        this.index = lunr(function () {
            this.ref('id');
            this.field('title', {boost: 10});
            this.field('content');
        });
        this.searchResults = $('.js-search-results').addClass('list-search-results');
    }

    Search.prototype = {
        constructor: Search,
        init: function () {
            this.createIndex();
            this.bindEvents();
        },
        createIndex: function () {
            var $this = this,
                indexFilePath = $('.js-search-input').data('roothref') + 'index.json';

            $.getJSON(indexFilePath, function (data) {
                $.each(data, function (key, item) {
                    $this.index.add({
                        id: item.id,
                        title: item.title,
                        content: item.content
                    });

                    $this.store[item.id] = {
                        href: item.id,
                        title: item.title,
                        content: item.content
                    }
                });
            });
        },
        bindEvents: function () {
            var $this = this;

            $('html')
                .on('click', function (event) {
                    $this.close($(this), event);
                });

            $('.js-search-input, .js-search-results')
                .on('click', function (event) {
                    $this.click($(this), event);
                });

            $('.js-search-input')
                .on('focus', function (event) {
                    $this.focus($(this), event);
                })
                .on('keyup', function (event) {
                    $this.search($(this), event)
                })
                .on('keydown', function (event) {
                    if ($('.js-search-results ul').is(':visible')){
                        $this.navigation($(this), event)
                    }
                })
        },
        click: function (element, event) {
            event.stopPropagation();
        },
        focus: function (element, event) {
            this.searchInputWidth = element.css('width');
            element.animate({
                'width': 600
            }, 500);
            $('#js-navbar-collapse > ul').fadeOut();
        },
        close: function (element, event) {
            var $this = this;

            $('.js-search-results').hide();
            $('.js-search-input').animate({
                'width': $this.searchInputWidth
            }, 500);
            $('#js-navbar-collapse > ul').fadeIn();
        },
        search: function (element, event) {
            var $this = this;

            if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40) {
                return;
            }

            var query = element.val(),
                results = $this.index.search(query);

            if (!results.length) {
                $this.searchResults.empty();
                return;
            }

            var resultsList = results.reduce(function (ul, result) {
                var item = $this.store[result.ref];
                var title = $('<b>').text(item.title);

                var cropText = $this.cropText(item.content, query);
                if (cropText.length === 0) {
                    cropText = $('<p>').html(item.content.substring(0, 120) + "...");
                }
                var content = content = $('<p>').html(cropText);

                var div = $('<div>')
                    .append(title)
                    .append(content);
                var a = $('<a>').attr('href', item.href)
                    .append(div);
                var li = $('<li>')
                    .append(a);
                ul.append(li);

                return ul;
            }, $('<ul>'));

            this.searchResults.html(resultsList);

            $('.js-search-results').show();
            $(".js-search-results li:first-child").addClass('selected');
        },
        cropText: function (content, query) {
            var cropedText = '',
                re = new RegExp("\\s?(.{0,30})?" + query + ".*?\\b(.{0,30}.)?\\s?", "gi");

            $.each(content.match(re), function (key, value) {
                cropedText += '...' + value + '...';
            });

            return cropedText;
        },
        navigation: function (element, event) {
            var selected = null,
                listSelector = ".js-search-results ul",
                listItemSelector = listSelector + " li",
                selectedListItemSelector = listItemSelector + ".selected",
                selectedListItemSelectorAnchor = listItemSelector + ".selected a";

            // enter
            if (event.keyCode == 13) {
                event.preventDefault();
                this.close();
                window.location.replace($(selectedListItemSelectorAnchor).attr('href'));
            }

            // up
            if (event.keyCode == 38) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.prev().length == 0) {
                    selected.siblings().last().addClass("selected");
                } else {
                    selected.prev().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListUp(selected);
            }

            // down
            if (event.keyCode == 40) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.next().length == 0) {
                    selected.siblings().first().addClass("selected");
                } else {
                    selected.next().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListDown(selected);
            }
        },
        scrollListDown: function (element) {
            var ul = element.parent(),
                ulHeight = ul.height(),
                ulBottomPosition = ulHeight + ul.scrollTop(),
                liBottomPosition = element.position().top + element.height();

            if (liBottomPosition > ulBottomPosition) {
                ul.scrollTop(liBottomPosition - ulHeight);
            }

            if (element.is(':first-child')) {
                ul.scrollTop(0);
            }
        },
        scrollListUp: function (element) {
            var ul = element.parent(),
                ulTopPosition = ul.scrollTop(),
                liTopPosition = element.position().top;

            if (liTopPosition < ulTopPosition) {
                ul.scrollTop(element.position().top);
            }

            if (element.is(':last-child')) {
                ul.scrollTop(element.position().top - element.height());
            }
        }
    };

    $(function () {
        var search = new Search();
        search.init();
    });
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="HandheldFriendly" content="True"/>
<title>PDO Connection</title>
    
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/cerulean/bootstrap.min.css" />
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
<link rel="stylesheet" href="https://tobiju.github.io/share/prismjs/prism-base16-ateliersulphurpool.light.css" />
<link rel="stylesheet" href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css" />
<link rel="stylesheet" href="/style.css" />
</head>
<body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-cerulean">
<div class="page-wrapper">
    <header>
    
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="box-header container">
        <form class="form-search navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text"
                       placeholder="Search"
                       class="js-search-input form-control"
                       data-roothref="/">

                <div class="js-search-results"></div>
            </div>
        </form>

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
                            <a class="navbar-brand" href="/">
                    <img alt="logo" src="https://raw.githubusercontent.com/atlasphp/atlasphp.github.io/master/images/atlas.png" title="Home">
                </a>
                    </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
                        <li>
    <a href="/dymaxion/">Dymaxion (v4)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/dymaxion/pdo/">PDO Connection</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/dymaxion/pdo/connection.html">PDO Connection</a>

    </li>
                        <li>
    <a href="/dymaxion/pdo/connection-locator.html">Connection Locator</a>

    </li>
                        <li>
    <a href="/dymaxion/pdo/upgrade.html">Upgrade Notes</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/">Cassini (v3)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/orm/">ORM</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/orm/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/cassini/orm/relationships.html">Mapper Relationships</a>

    </li>
                        <li>
    <a href="/cassini/orm/reading.html">Fetching Records and RecordSets</a>

    </li>
                        <li>
    <a href="/cassini/orm/records.html">Working with Records</a>

    </li>
                        <li>
    <a href="/cassini/orm/record-sets.html">Working with RecordSets</a>

    </li>
                        <li>
    <a href="/cassini/orm/transactions.html">Transactions</a>

    </li>
                        <li>
    <a href="/cassini/orm/behavior.html">Record and RecordSet Behaviors</a>

    </li>
                        <li>
    <a href="/cassini/orm/events.html">Events</a>

    </li>
                        <li>
    <a href="/cassini/orm/direct.html">Direct Queries</a>

    </li>
                        <li>
    <a href="/cassini/orm/other.html">Other Topics</a>

    </li>
                        <li>
    <a href="/cassini/orm/domain.html">Domain Models</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/skeleton/">Skeleton Generator</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/skeleton/usage.html">Usage</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/table/">Table Data Gateway</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/table/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/cassini/table/reading.html">Reading From The Table</a>

    </li>
                        <li>
    <a href="/cassini/table/writing.html">Writing To The Table</a>

    </li>
                        <li>
    <a href="/cassini/table/events.html">Table Events</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/query/">Query System</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/query/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/cassini/query/binding.html">Value Binding</a>

    </li>
                        <li>
    <a href="/cassini/query/select.html">SELECT</a>

    </li>
                        <li>
    <a href="/cassini/query/insert.html">INSERT</a>

    </li>
                        <li>
    <a href="/cassini/query/update.html">UPDATE</a>

    </li>
                        <li>
    <a href="/cassini/query/delete.html">DELETE</a>

    </li>
                        <li>
    <a href="/cassini/query/other.html">Other Topics</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/info/">Schema Information</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/info/usage.html">Usage</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/cassini/pdo/">PDO Connection</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/cassini/pdo/connection.html">PDO Connection</a>

    </li>
                        <li>
    <a href="/cassini/pdo/connection-locator.html">Connection Locator</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/boggs/">Boggs (v2)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/boggs/mapper/">ORM</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/boggs/mapper/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/boggs/mapper/relationships.html">Mapper Relationships</a>

    </li>
                        <li>
    <a href="/boggs/mapper/reading.html">Fetching Records and RecordSets</a>

    </li>
                        <li>
    <a href="/boggs/mapper/records.html">Working with Records</a>

    </li>
                        <li>
    <a href="/boggs/mapper/record-sets.html">Working with RecordSets</a>

    </li>
                        <li>
    <a href="/boggs/mapper/transactions.html">Transactions (Unit of Work)</a>

    </li>
                        <li>
    <a href="/boggs/mapper/behavior.html">Record and RecordSet Behaviors</a>

    </li>
                        <li>
    <a href="/boggs/mapper/events.html">Events</a>

    </li>
                        <li>
    <a href="/boggs/mapper/direct.html">Direct Queries</a>

    </li>
                        <li>
    <a href="/boggs/mapper/domain.html">Domain Models</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/boggs/skeleton/">Skeleton Generator</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/boggs/skeleton/getting-started.html">Atlas.Cli 1.x</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/albers/">Albers (v1)</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/albers/mapper/">ORM</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/albers/mapper/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/albers/mapper/relationships.html">Mapper Relationships</a>

    </li>
                        <li>
    <a href="/albers/mapper/reading.html">Fetching Records and RecordSets</a>

    </li>
                        <li>
    <a href="/albers/mapper/records.html">Working with Records</a>

    </li>
                        <li>
    <a href="/albers/mapper/record-sets.html">Working with RecordSets</a>

    </li>
                        <li>
    <a href="/albers/mapper/transactions.html">Transactions (Unit of Work)</a>

    </li>
                        <li>
    <a href="/albers/mapper/behavior.html">Record and RecordSet Behaviors</a>

    </li>
                        <li>
    <a href="/albers/mapper/events.html">Events</a>

    </li>
                        <li>
    <a href="/albers/mapper/direct.html">Direct Queries</a>

    </li>
                        <li>
    <a href="/albers/mapper/domain.html">Domain Models</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/albers/skeleton/">Skeleton Generator</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/albers/skeleton/getting-started.html">Atlas.Cli 1.x</a>

    </li>
            </ul>

    </li>
            </ul>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <ol class="breadcrumb">
                        <li><a href="/">Atlas Database Framework for PHP</a></li>
                                <li><a href="/dymaxion/">Dymaxion (v4)</a></li>
                                <li><a href="/dymaxion/pdo/">PDO Connection</a></li>
                                <li class="active">PDO Connection</li>
            </ol>
    <div class="row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#1-1-1" title="PDO&#x20;Connection">PDO Connection</a>
            </li>
                                <li>
                <a href="#1-1-1-1" title="Installation">Installation</a>
            </li>
                                <li>
                <a href="#1-1-1-2" title="Instantiation">Instantiation</a>
            </li>
                                <li>
                <a href="#1-1-1-3" title="Calling&#x20;PDO&#x20;Methods">Calling PDO Methods</a>
            </li>
                                <li>
                <a href="#1-1-1-4" title="Performing&#x20;Queries">Performing Queries</a>
            </li>
                                <li>
                <a href="#1-1-1-5" title="Fetching&#x20;Results">Fetching Results</a>
            </li>
                                                                                                                                                        <li>
                <a href="#1-1-1-6" title="Yielding&#x20;Results">Yielding Results</a>
            </li>
                                                                                            <li>
                <a href="#1-1-1-7" title="Explicit&#x20;Bind&#x20;Value&#x20;Types">Explicit Bind Value Type...</a>
            </li>
                                <li>
                <a href="#1-1-1-8" title="Query&#x20;Logging">Query Logging</a>
            </li>
                                                        <li>
                <a href="#1-1-1-9" title="Persistent&#x20;Connections">Persistent Connections</a>
            </li>
            </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="1-1-1">1.1.1. PDO Connection</h1>
<h2 id="1-1-1-1">1.1.1.1. Installation</h2>
<p>This package is installable and autoloadable via <a href="https://getcomposer.org/">Composer</a>
as <a href="https://packagist.org/packages/atlas/pdo">atlas/pdo</a>.</p>
<pre><code>composer require atlas/pdo ^2.0
</code></pre>
<h2 id="1-1-1-2">1.1.1.2. Instantiation</h2>
<p>The easiest way to create a <em>Connection</em> is to use its static  <code>new()</code> method,
either with <em>PDO</em> connection arguments, or with an actual <em>PDO</em> instance:</p>
<pre><code class="language-php">use Atlas\Pdo\Connection;

// pass PDO constructor arguments ...
$connection = Connection::new(
    'mysql:host=localhost;dbname=testdb',
    'username',
    'password'
);

// ... or a PDO instance.
$connection = Connection::new($pdo);
</code></pre>
<p>If you need a callable factory to create a <em>Connection</em> and its PDO instance at
a later time, such as in a service container, you can use the
<code>Connection::factory()</code> method:</p>
<pre><code class="language-php">use Atlas\Pdo\Connection;

// get a callable factory that creates a Connection
$factory = Connection::factory('sqlite::memory:');

// later, call the factory to instantiate the Connection
$connection = $factory();
</code></pre>
<p>If you want to make sure certain SQL queries are run at connection time, you can
create your own callable factory:</p>
<pre><code class="language-php">use Atlas\Pdo\Connection;

// define a callable factory that creates a Connection and executes a query
$factory = function () {
    $connection = Connection::new('sqlite::memory:');
    $connection-&gt;exec('...');
    return $connection;
}

// later, call the factory to instantiate the Connection
$connection = $factory();
</code></pre>
<h2 id="1-1-1-3">1.1.1.3. Calling PDO Methods</h2>
<p>The <em>Connection</em> acts as a proxy to the decorated PDO instance, so you can call
any method on the <em>Connection</em> that you would normally call on PDO.</p>
<h2 id="1-1-1-4">1.1.1.4. Performing Queries</h2>
<p>Instead of issuing <code>prepare()</code>, a series of <code>bindValue()</code> calls, and then
<code>execute()</code>, you can bind values and get back a <em>PDOStatement</em> result in one
call using the <em>Connection</em> <code>perform()</code> method:</p>
<pre><code class="language-php">$stm  = 'SELECT * FROM test WHERE foo = :foo AND bar = :bar';
$bind = ['foo' =&gt; 'baz', 'bar' =&gt; 'dib'];

$sth = $connection-&gt;perform($stm, $bind);
</code></pre>
<h2 id="1-1-1-5">1.1.1.5. Fetching Results</h2>
<p>The <em>Connection</em> provides several <code>fetch*()</code> methods to help reduce boilerplate
code; these all use <code>perform()</code> internally.</p>
<h3 id="1-1-1-5-1">1.1.1.5.1. fetchAffected()</h3>
<p>The <code>fetchAffected()</code> method returns the number of affected rows.</p>
<pre><code class="language-php">$stm = "UPDATE test SET incr = incr + 1 WHERE foo = :foo AND bar = :bar";
$bind = ['foo' =&gt; 'baz', 'bar' =&gt; 'dib'];
$rowCount = $connection-&gt;fetchAffected($stm, $bind);
</code></pre>
<h3 id="1-1-1-5-2">1.1.1.5.2. fetchAll()</h3>
<p>The <code>fetchAll()</code> method returns a sequential array of all rows; each row is an
associative array where the keys are the column names.</p>
<pre><code class="language-php">$stm  = 'SELECT * FROM test WHERE foo = :foo AND bar = :bar';
$bind = ['foo' =&gt; 'baz', 'bar' =&gt; 'dib'];

$result = $connection-&gt;fetchAll($stm, $bind);
</code></pre>
<h3 id="1-1-1-5-3">1.1.1.5.3. fetchColumn()</h3>
<p>The <code>fetchColumn()</code> method returns a sequential array of the first column from
all rows.</p>
<pre><code class="language-php">$result = $connection-&gt;fetchColumn($stm, $bind);
</code></pre>
<p>You can choose another column number with an optional third argument (columns
are zero-indexed):</p>
<pre><code class="language-php">// use column 3 (i.e. the 4th column)
$result = $connection-&gt;fetchColumn($stm, $bind, 3);
</code></pre>
<h3 id="1-1-1-5-4">1.1.1.5.4. fetchGroup()</h3>
<p>The <code>fetchGroup()</code> method is like <code>fetchUnique()</code> except that the values aren't
wrapped in arrays. Instead, single column values are returned as a single
dimensional array and multiple columns are returned as an array of arrays.</p>
<pre><code class="language-php">$result = $connection-&gt;fetchGroup($stm, $bind, $style = PDO::FETCH_COLUMN)
</code></pre>
<p>Set <code>$style</code> to <code>PDO::FETCH_NAMED</code> when values are an array (i.e. there are more
than two columns in the select).</p>
<h3 id="1-1-1-5-5">1.1.1.5.5. fetchKeyPair()</h3>
<p>The <code>fetchKeyPair()</code> method returns an associative array where each key is the
first column and each value is the second column</p>
<pre><code class="language-php">$result = $connection-&gt;fetchKeyPair($stm, $bind);
</code></pre>
<h3 id="1-1-1-5-6">1.1.1.5.6. fetchObject()</h3>
<p>The <code>fetchObject()</code> method returns the first row as an object of your choosing;
the columns are mapped to object properties. An optional 4th parameter array
provides constructor arguments when instantiating the object.</p>
<pre><code class="language-php">$result = $connection-&gt;fetchObject($stm, $bind, 'ClassName', ['ctor_arg_1']);
</code></pre>
<h3 id="1-1-1-5-7">1.1.1.5.7. fetchObjects()</h3>
<p>The <code>fetchObjects()</code> method returns an array of objects of your choosing; the
columns are mapped to object properties. An optional 4th parameter array
provides constructor arguments when instantiating the object.</p>
<pre><code class="language-php">$result = $connection-&gt;fetchObjects($stm, $bind, 'ClassName', ['ctor_arg_1']);
</code></pre>
<h3 id="1-1-1-5-8">1.1.1.5.8. fetchOne()</h3>
<p>The <code>fetchOne()</code> method returns the first row as an associative array where the
keys are the column names.</p>
<pre><code class="language-php">$result = $connection-&gt;fetchOne($stm, $bind);
</code></pre>
<h3 id="1-1-1-5-9">1.1.1.5.9. fetchUnique()</h3>
<p>The <code>fetchUnique()</code> method returns an associative array of all rows where the
key is the value of the first column, and the row arrays are keyed on the
remaining column names.</p>
<pre><code class="language-php">$result = $connection-&gt;fetchUnique($stm, $bind);
</code></pre>
<h3 id="1-1-1-5-10">1.1.1.5.10. fetchValue()</h3>
<p>The <code>fetchValue()</code> method returns the value of the first row in the first
column.</p>
<pre><code class="language-php">$result = $connection-&gt;fetchValue($stm, $bind);
</code></pre>
<h2 id="1-1-1-6">1.1.1.6. Yielding Results</h2>
<p>The <em>Connection</em> provides several <code>yield*()</code> methods to help reduce memory
usage.</p>
<p>Whereas <code>fetch*()</code> methods may collect all the query result rows before
returning them all at once, the equivalent <code>yield*()</code> methods generate one
result row at a time.</p>
<h3 id="1-1-1-6-1">1.1.1.6.1. yieldAll()</h3>
<p>This is the yielding equivalent of <code>fetchAll()</code>.</p>
<pre><code class="language-php">foreach ($connection-&gt;yieldAll($stm, $bind) as $row) {
    // ...
}
</code></pre>
<h3 id="1-1-1-6-2">1.1.1.6.2. yieldColumn()</h3>
<p>This is the yielding equivalent of <code>fetchColumn()</code>.</p>
<pre><code class="language-php">
foreach ($connection-&gt;yieldColumn($stm, $bind) as $val) {
    // ...
}
</code></pre>
<h3 id="1-1-1-6-3">1.1.1.6.3. yieldKeyPair()</h3>
<p>This is the yielding equivalent of <code>fetchKeyPair()</code>.</p>
<pre><code class="language-php">foreach ($connection-&gt;yieldKeyPair($stm, $bind) as $key =&gt; $val) {
    // ...
}
</code></pre>
<h3 id="1-1-1-6-4">1.1.1.6.4. yieldObjects()</h3>
<p>This is the yielding equivalent of <code>fetchObjects()</code>.</p>
<pre><code class="language-php">$class = 'ClassName';
$args = ['arg0', 'arg1', 'arg2'];
foreach ($connection-&gt;yieldObjects($stm, $bind, $class, $args) as $object) {
    // ...
}
</code></pre>
<h3 id="1-1-1-6-5">1.1.1.6.5. yieldUnique()</h3>
<p>This is the yielding equivalent of <code>fetchUnique()</code>.</p>
<pre><code class="language-php">foreach ($connection-&gt;yieldUnique($stm, $bind) as $key =&gt; $row) {
    // ...
}
</code></pre>
<h2 id="1-1-1-7">1.1.1.7. Explicit Bind Value Types</h2>
<p>When binding values on a <code>perform()</code>-based query (which includes all <code>fetch*()</code>
and <code>yield*()</code> queries), the <em>Connection</em> will use <code>PDO::PARAM_STR</code> as the value
type by default.</p>
<p>If you want to override the default type, pass the value as an array where
the first element is the value and the second element is the PDO param type.
For example:</p>
<pre><code class="language-php">// PDO::PARAM_STR by default
$bind['foo'] = 1;

// force to PDO::PARAM_INT
$bind['foo'] = [1, PDO::PARAM_INT]
</code></pre>
<blockquote>
<p><strong>Note:</strong></p>
<p>If you pass a boolean value and force the type to <code>PDO::PARAM_BOOL</code>, the
<em>Connection</em> will store the value as a string '0' for <code>false</code> or string '1'
for <code>true</code>. This addresses issues with a long-standing behavior in PDO.</p>
</blockquote>
<h2 id="1-1-1-8">1.1.1.8. Query Logging</h2>
<p>It is sometimes useful to see a log of all queries passing through a
<em>Connection</em>. To do so, call its <code>logQueries()</code> method, issue your queries, and
then call <code>getQueries()</code>.</p>
<pre><code class="language-php">// start logging
$connection-&gt;logQueries(true);

// at this point, all query(), exec(), perform(), fetch*(), and yield*()
// queries will be logged.

// get the query log entries
$queries = $connection-&gt;getQueries();

// stop logging
$connection-&gt;logQueries(false);
</code></pre>
<p>Each query log entry will be an array with these keys:</p>
<ul>
<li>
<code>start</code>: when the query started</li>
<li>
<code>finish</code>: when the query finished</li>
<li>
<code>duration</code>: how long the query took</li>
<li>
<code>performed</code>: whether or not the query was actually perfomed; useful
for seeing if a <code>COMMIT</code> actually occurred</li>
<li>
<code>statement</code>: the query statement string</li>
<li>
<code>values</code>: the array of bound values</li>
<li>
<code>trace</code>: an exception trace showing where the query was issued</li>
</ul>
<h3 id="1-1-1-8-1">1.1.1.8.1. Logged Statements</h3>
<p>When queries are not being logged, <code>Connection::prepare()</code> will return a normal
<em>PDOStatement</em>. However, when queries <em>are</em> being logged, <code>Connection::prepare()</code>
will return an <em>Atlas\Pdo\LoggedStatement</em> instance instead.</p>
<p>The <em>LoggedStatement</em> is an extension of <em>PDOStatement</em>, so it works the same
way, but it has the added behavior of recording to the log when its <code>execute()</code>
method is called.</p>
<h3 id="1-1-1-8-2">1.1.1.8.2. Custom Loggers</h3>
<p>You may wish to set a custom logger on the <em>Connection</em>. To do so, call
<code>setQueryLogger()</code> and pass a callable with the signature
<code>function (array $entry) : void</code>.</p>
<pre><code class="language-php">class CustomDebugger
{
    public function __invoke(array $entry) : void
    {
        // call an injected logger to record the entry
    }
}

$customDebugger = new CustomDebugger();
$connection-&gt;setQueryLogger($customDebugger);
$connection-&gt;logQueries(true);

// now the Connection will send query log entries to the CustomDebugger
</code></pre>
<blockquote>
<p><strong>Note:</strong></p>
<p>If you set a custom logger, the <em>Connection</em> will no longer retain its own
query log entries; they will all go to the custom logger. This means that
<code>getQueries()</code> on the <em>Connection</em> not show any new entries.</p>
</blockquote>
<h2 id="1-1-1-9">1.1.1.9. Persistent Connections</h2>
<p><strong>Unlogged</strong> persistent <em>Connection</em> instances are fully supported, via the
<a href="https://www.php.net/manual/en/pdo.connections.php"><code>PDO::ATTR_PERSISTENT</code></a>
option at construction time.</p>
<p><strong>Logged</strong> persistent <em>Connection</em> instances are <em>almost</em> fully supported. The
only exception to full support is that, on calling <code>Connection::prepare()</code>, the
returned statement instance (<em>PersistentLoggedStatement</em>) does not honor the
<code>PDOStatement::bindColumn()</code> method. All other methods and behaviors are fully
supported.</p>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="/dymaxion/pdo/">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="/dymaxion/pdo/connection-locator.html">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>&copy; 2015-2018, Atlas for PHP</p>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="http://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
<script src="https://tobiju.github.io/share/prismjs/main.js"></script>
<script src="https://tobiju.github.io/share/prismjs/prism.js"></script>
<script type="text/javascript">

    function Search() {
        this.store = {};
        this.index = lunr(function () {
            this.ref('id');
            this.field('title', {boost: 10});
            this.field('content');
        });
        this.searchResults = $('.js-search-results').addClass('list-search-results');
    }

    Search.prototype = {
        constructor: Search,
        init: function () {
            this.createIndex();
            this.bindEvents();
        },
        createIndex: function () {
            var $this = this,
                indexFilePath = $('.js-search-input').data('roothref') + 'index.json';

            $.getJSON(indexFilePath, function (data) {
                $.each(data, function (key, item) {
                    $this.index.add({
                        id: item.id,
                        title: item.title,
                        content: item.content
                    });

                    $this.store[item.id] = {
                        href: item.id,
                        title: item.title,
                        content: item.content
                    }
                });
            });
        },
        bindEvents: function () {
            var $this = this;

            $('html')
                .on('click', function (event) {
                    $this.close($(this), event);
                });

            $('.js-search-input, .js-search-results')
                .on('click', function (event) {
                    $this.click($(this), event);
                });

            $('.js-search-input')
                .on('focus', function (event) {
                    $this.focus($(this), event);
                })
                .on('keyup', function (event) {
                    $this.search($(this), event)
                })
                .on('keydown', function (event) {
                    if ($('.js-search-results ul').is(':visible')){
                        $this.navigation($(this), event)
                    }
                })
        },
        click: function (element, event) {
            event.stopPropagation();
        },
        focus: function (element, event) {
            this.searchInputWidth = element.css('width');
            element.animate({
                'width': 600
            }, 500);
            $('#js-navbar-collapse > ul').fadeOut();
        },
        close: function (element, event) {
            var $this = this;

            $('.js-search-results').hide();
            $('.js-search-input').animate({
                'width': $this.searchInputWidth
            }, 500);
            $('#js-navbar-collapse > ul').fadeIn();
        },
        search: function (element, event) {
            var $this = this;

            if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40) {
                return;
            }

            var query = element.val(),
                results = $this.index.search(query);

            if (!results.length) {
                $this.searchResults.empty();
                return;
            }

            var resultsList = results.reduce(function (ul, result) {
                var item = $this.store[result.ref];
                var title = $('<b>').text(item.title);

                var cropText = $this.cropText(item.content, query);
                if (cropText.length === 0) {
                    cropText = $('<p>').html(item.content.substring(0, 120) + "...");
                }
                var content = content = $('<p>').html(cropText);

                var div = $('<div>')
                    .append(title)
                    .append(content);
                var a = $('<a>').attr('href', item.href)
                    .append(div);
                var li = $('<li>')
                    .append(a);
                ul.append(li);

                return ul;
            }, $('<ul>'));

            this.searchResults.html(resultsList);

            $('.js-search-results').show();
            $(".js-search-results li:first-child").addClass('selected');
        },
        cropText: function (content, query) {
            var cropedText = '',
                re = new RegExp("\\s?(.{0,30})?" + query + ".*?\\b(.{0,30}.)?\\s?", "gi");

            $.each(content.match(re), function (key, value) {
                cropedText += '...' + value + '...';
            });

            return cropedText;
        },
        navigation: function (element, event) {
            var selected = null,
                listSelector = ".js-search-results ul",
                listItemSelector = listSelector + " li",
                selectedListItemSelector = listItemSelector + ".selected",
                selectedListItemSelectorAnchor = listItemSelector + ".selected a";

            // enter
            if (event.keyCode == 13) {
                event.preventDefault();
                this.close();
                window.location.replace($(selectedListItemSelectorAnchor).attr('href'));
            }

            // up
            if (event.keyCode == 38) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.prev().length == 0) {
                    selected.siblings().last().addClass("selected");
                } else {
                    selected.prev().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListUp(selected);
            }

            // down
            if (event.keyCode == 40) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.next().length == 0) {
                    selected.siblings().first().addClass("selected");
                } else {
                    selected.next().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListDown(selected);
            }
        },
        scrollListDown: function (element) {
            var ul = element.parent(),
                ulHeight = ul.height(),
                ulBottomPosition = ulHeight + ul.scrollTop(),
                liBottomPosition = element.position().top + element.height();

            if (liBottomPosition > ulBottomPosition) {
                ul.scrollTop(liBottomPosition - ulHeight);
            }

            if (element.is(':first-child')) {
                ul.scrollTop(0);
            }
        },
        scrollListUp: function (element) {
            var ul = element.parent(),
                ulTopPosition = ul.scrollTop(),
                liTopPosition = element.position().top;

            if (liTopPosition < ulTopPosition) {
                ul.scrollTop(element.position().top);
            }

            if (element.is(':last-child')) {
                ul.scrollTop(element.position().top - element.height());
            }
        }
    };

    $(function () {
        var search = new Search();
        search.init();
    });
</script>
</body>
</html>
